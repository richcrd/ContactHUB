@model IEnumerable<ContactHUB.Models.Etiqueta>
@{
    ViewData["Title"] = "Etiquetas";
}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Etiquetas</h2>
        <button class="btn btn-success" id="btnNuevaEtiqueta"><i class="bi bi-plus-circle"></i> Nueva Etiqueta</button>
    </div>
    <div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080; min-width: 300px;">
        <div id="toast-container"></div>
    </div>
    <table class="table table-hover align-middle shadow-sm bg-white rounded" id="tabla-etiquetas">
        <thead class="table-light" id="thead-etiquetas">
            <tr>
                <th>#</th>
                <th>Nombre</th>
                <th class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr data-id="@item.IdEtiqueta">
                    <td>@item.IdEtiqueta</td>
                    <td>@item.Nombre</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-primary me-1 btn-editar" data-id="@item.IdEtiqueta"><i class="bi bi-pencil"></i></button>
                        <form asp-action="Eliminar" asp-route-id="@item.IdEtiqueta" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('¿Eliminar etiqueta?');"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>

</div>
<!-- Modal Etiqueta (Crear/Editar) -->
<div class="modal fade" id="etiquetaModal" tabindex="-1" aria-labelledby="etiquetaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="etiquetaModalLabel"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="etiquetaModalBody">
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
</div>
<script>
function showToast(message, type) {
    var toastId = 'toast-' + Date.now();
    var toastHtml = `<div id="${toastId}" class="toast align-items-center text-bg-` + type + ` border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3500">` +
        `<div class="d-flex">` +
        `<div class="toast-body">` + message + `</div>` +
        `<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>` +
        `</div></div>`;
    var $toast = $(toastHtml);
    $('#toast-container').append($toast);
    var toast = new bootstrap.Toast($toast[0]);
    toast.show();
    $toast.on('hidden.bs.toast', function(){ $toast.remove(); });
}

function openEtiquetaModal(url, title) {
    $("#etiquetaModalLabel").text(title);
    $("#etiquetaModalBody").html('<div class="text-center p-4"><div class="spinner-border"></div></div>');
    $("#etiquetaModal").modal("show");
    $.get(url, function(data) {
        $("#etiquetaModalBody").html(data);
    });
}

function submitEtiquetaForm(actionUrl) {
    var form = $("#etiquetaModalBody form");
    var formData = form.serialize(); // Incluye todos los campos, incluido el token
    $.ajax({
        url: actionUrl,
        method: 'POST',
        data: formData,
        success: function(result) {
            if (result.success) {
                var modal = $("#etiquetaModal");
                modal.modal("hide");
                // Limpiar contenido del modal al cerrar para evitar focus warnings
                modal.on('hidden.bs.modal', function () {
                    $("#etiquetaModalBody").html("");
                    modal.off('hidden.bs.modal');
                });
                // Actualizar solo la tabla sin recargar
                $.get(window.location.href, function(pageHtml){
                    var newTbody = $(pageHtml).find('#tabla-etiquetas tbody').html();
                    $('#tabla-etiquetas tbody').html(newTbody);
                    showToast('Operación realizada correctamente.', 'success');
                });
            } else {
                $("#etiquetaModalBody").html(result.html);
                if (result.errors && result.errors.length > 0) {
                    result.errors.forEach(function(err) {
                        showToast(err, 'danger');
                    });
                }
            }
        }
    });
}

// Soporte de modo oscuro para tabla de etiquetas
function applyDarkTableEtiquetas() {
    if (document.body.classList.contains('theme-dark')) {
        $('#tabla-etiquetas').addClass('table-dark');
        $('#thead-etiquetas').removeClass('table-light').addClass('table-dark');
        $('#tabla-etiquetas tbody tr').css('background-color', ''); // reset
    } else {
        $('#tabla-etiquetas').removeClass('table-dark');
        $('#thead-etiquetas').removeClass('table-dark').addClass('table-light');
        $('#tabla-etiquetas tbody tr').css('background-color', ''); // reset
    }
}

$(function(){
    // Mostrar toast si hay TempData
    @if (TempData["Success"] != null)
    {
        <text>showToast('@TempData["Success"]'.replace(/'/g, "\'"), 'success');</text>
    }
    @if (TempData["Error"] != null)
    {
        <text>showToast('@TempData["Error"]'.replace(/'/g, "\'"), 'danger');</text>
    }
    // Abrir modal para crear
    $('#btnNuevaEtiqueta').on('click', function(){
        openEtiquetaModal('@Url.Action("Crear")', 'Nueva Etiqueta');
    });
    // Abrir modal para editar
    $('#tabla-etiquetas').on('click', '.btn-editar', function(){
        var id = $(this).data('id');
        openEtiquetaModal('@Url.Action("Editar")/' + id, 'Editar Etiqueta');
    });
    // Delegar submit de formularios de modal
    $('#etiquetaModal').on('submit', 'form', function(e){
        e.preventDefault();
        var actionUrl = $(this).attr('action');
        submitEtiquetaForm(actionUrl);
    });
    // Inicializar modo oscuro
    applyDarkTableEtiquetas();
    // Reaplicar al cambiar tema
    const observerEtiquetas = new MutationObserver(applyDarkTableEtiquetas);
    observerEtiquetas.observe(document.body, { attributes: true, attributeFilter: ['class'] });
});
</script>
